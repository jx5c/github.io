[Music] good morning everyone and welcome back to ideas 6282 100 a class and in this week we post a quite some materials about the memory management and also the operating system security okay so in this week we are discussing about OSS security [Music] and also something related to the memory like the buffer overflow [Music] surprisingly also buffer overflow has bothered the security people for a very long time but until now although there are different approach that proposed to defend against and such attack actually very frequently you can see some severe vulnerability some severe availabilities into the modern system it is still triggered or caused by buffer overflow okay so we're going to record two videos for this series first we are going to do a quick review of the memory management and why it is still vulnerable to cyber attacks and in the second and also we will introduce the return oriented programming we post a video from other sources to explaining the ROP attack but we would like to provide a little bit more explanation and then in the second video we are going to introduce the defense against at the ROP attack okay so without further delay let's first a look at it okay so in the modern OS [Music] most of time now the Code section or the executable section in other words the place that you stored executable files and the data section they're separated what does that mean so we have a coda section and we have a data section in the modern operating system so you can only run executable or you can only execute the instructions in this part okay the PC pointer pointed to the next instruction that you're going to run so you are going to move back and forth only in this section and all the data will be stored here why is that the reason is from the modern operating system point of view it's very hard to control the data we cannot say oh this segment of data does not look good so you cannot you know you so if I define an array oh you cannot give your array number fifth element the value of five because that looks malicious that does not make sense because the data section belongs to the user and the user should be able to put whatever data into the data section the problem is if the if the bad guy or the attacker their create the executable file or the series of malicious instruction as data so basically the bad guy will put a bunch of malicious instructions in this section and a decorated data because I just have a file and I can put whatever value into my file right and then if somehow the system will allow the next instruction to be executed at jump to here so in other words we are going to execute instructions in data section then basically we're going to be in big trouble because the bad guy will put will be able to put whatever things he wants here and then somehow manipulate the PC register and somehow trick the execution to be here okay but now the modern operating system try to draw a plea a pretty clear line that will prevent the execution pointer to jump to the data section okay so in this way you can only touch this part but you cannot really run any data part so this actually greatly reduced the cyberattack there are still certain systems in which the data and the code section are actually bound together there's no clear separation most of them are IOT devices or sensors or the mobile systems you know the ones that with relatively weak processing capability and very little memory so we do not have the luxury to actually separate the code section from the data section you know for some of the you know for some of the smart home devices and it's very tiny and still it try to run an operating system and try to achieve a lot of functionality for those type of things very frequently you're going to have the data section in a coded section bound together so that is one thing people have adopted it to to avoid this type of issue okay and of course there are subsequent attacks from the bad guys point of view okay so now we have separated the data section and the decoder section and then the bad guy starts to use the buffer overflow attack okay and there has been quite a few videos we posted a related above overflow we will not describe them specifically but we would like to refer you so you can see here this is a wiki page introducing the I would drag it this a little bit down so that you can see it this is actually introduce the data structure of stack okay so stack is the it has a broader broader usage other than computer science but we are subsets like a about one image of this let me drag this into the middle let's see can we make a lot or oh yes we can see okay I think it's all in the screen so let's highlight this section and read it through this quickly okay this is a typical stack storing local data and a call information remember this is directly related to a function calls because it says it's towards call information for necess the procedure called well the neccessity is different from the data structure or is different from the algorithm course that you mean the nested okay this deck grows downwards so it grows down girls down so you can see this is the stack or region and when a system first boot the pointer of this deck had is here and every time there's a function call a frame will be created it it grows down it grows down and that is why here is the stack pointer and this is the active frame okay this dot step goes downward Fermi's or written the stack pointer point to the Carlmont datum of the stack okay each procedure called in the program stores procedure return address and the local data by pushing them into the stack so you can see okay this is the very first a function call that a -3 is actually the first call in a store a lot of data used by the N minus 3 and minus 3 function call into the stack and then it put it into the return address okay so what happens the series of code is like this so this is function and minus 3 sorry let's clean this up so first we have a minus three well suddenly it started to become crazy okay this is n minus 3 and the instruction 1 instruction 2 and then it call a minus 2 and then it jumped to an minus 2 instruction can instruction 11 and then you call an minus 1 so low and so forth so this and minus 3 is actually the outmost a function call okay so let's look at this so um minus 3 running running running and then there's an unmanned of 2 and minus 3 : minus 2 so this frame belongs to a minus 3 and there's a return address for a minus 3 actually point to here which is the instruction 3 that is the return address 2 and minus 3 y because you call the function + - - after a minus 2 is finished executed it should be come back and when to come back it should go to the next instruction immediately after this function call so that's why this is the return address of this frame this yellow sticker ok so you can see this will represent a whole lot of function calls coming on down down down and when the out most or I'm sorry when the current of function number n is down it will return back to the function call and minus 1 and this represent the address okay so now let's look at a what is the ROP attack the return-oriented programming attack okay if you recall in the previous well about three or two minutes ago we just introduced that well now we have a clear section between the code section and the data section make sense because now we have a clear distinction between the two part you cannot run the data section as as executables or as the instructions so now we have a problem we are only allowed to run something in this code section and there are two ways for the bad guys to do something the first is inject malicious code into this coda section the other way is just use segments of benign sections and weave them together leave them together to do evil things okay of course this is looks attractive to the bad guy if somehow I can grab the control of your system and I can actually embed malicious code a section into here and then I ask you to directly run this section dirty code that'd be great the problem is now the security program will start to scan is called a section very frequently and try to locate any suspicious or malicious code a section so if you have a big chunk of malicious code the the antivirus software will actually catch you so this is attractive but it's become harder and harder now the bad guys started to use this approach let's use segment of benign code to do some evil things what does I mean well you must have watched some spy movies you know you can go to the supermarket I don't think that's true but you know in the spy movie they do that anyway you go to the you go to the supermarket you buy some soap you buy some laundry powder you buy some coconut oil and then somehow you mix them together you can build a bomb okay don't follow this instruction don't do anything illegal or just to try to explain this use benign segments to build evil things okay so if you recall if you if you look at this it's totally legal to buy soap to buy laundry powder and buy coconut oil separately or it's totally legal right they have legal use the problem is if you mix them with a certain percentage it will become explosive it is the same thing here okay what is a malicious what is a malicious called a segment okay it's just a whole bunch of the instruction right the only thing is when when you weave those instructions together they do evil things right so you have a malicious segment of code consists of instruction one instruction to all the way until instruction a hundred so let's simplify it let's say this malicious segment is just consists of a hundred instructions okay so now we cannot directly embedded this 100 instructions next to each other into the code section because antivirus software will find it so what do we do we put them in two different pieces for example instruction one two five will be a section and then six to thirteen will be another section so on and so forth with just a need to break them into different sections and then what do we do we find instruction one two five exactly same section exactly the same instructions into the benign code why any operating system or application contains huge amount of instructions okay so we just needed to scan all those instructions and find a sequence of five instructions from one to five that is what we want that it's the first evil piece we can find that it's the soap that you need to build the bomb okay there is a problem let's say we find instruction one two five sorry let's say we find the instruction 1 to 5 in the benign application there is instruction 6 after it or remember this 6 is not necessarily this 6 you want well we cannot interrupt here right because if we jump to this benign operation benign program it will start to run from here and it will continue running until it see a jump or a return so that's why we not only need to find the instruction 1 to 5 we also need a return immediately after yet ok so I think now you started to get that field or you start to get the feeling of how the return oriented programming is actually trying to do ok I want to learn the instruction from 1 to 100 from the bad guys point of view but I do not have them so what should I do I first to find the segments which are instructions one two five well again the the sorry let's see whether or not this will help it so this is instruction one two five it also happened in some benign applications okay but we need a return immediately after it so basically we are searching the bina application find a segment of code with the instruction one two five there's a return immediately after it and then we are looking for a section of six to thirteen and there is a return after if immediately and then we are very unlucky we can only find two instructions we need salon and so forth after refine it and this is the stack okay it's really weird for a short period of time the pan is working and now he's stopped working and now let's look at it a frame it's crazy okay so every block here actually represent a frame like a function call okay so what will be the return address the return address that the bad guy will need to set it up will be here and then here and then of course here okay so there you'll need it to weave them together okay and this is let's say is our tool and god forbid and to be crazy and this will be our three okay so when you do the buffer overflow you will first make it to start to execute here the r1 and then you need to put all the frames corresponding address okay so you start to learn from here from r1 okay after you run r1 the return it will execute the return man and here you put our tool here the return address tool it will directly jump to here start to you to execute instruction six to thirteen and then our three here and our four here okay remember the stack is growing down and when the function is returning it go backs up okay so your champion to here are one and put r2 r3 r4 all the address you needed into the stack and and I need to start to run and after the first segment it will go to r2 started to run the second segment and so long and so forth okay through this you actually leave the benign sections of good code together and ask them to do some dirty things and of course you will ask well you have to be really lucky that you can find the instructions that you need and immediately follow the pile return right because if there is another instruction before the return you cannot get the malicious logic you are totally right that's why if you look at the paper or you look at the videos that before our video you will notice that the researchers have scanned the executable file of the Linux system they actually find all the instructions they have found all the instructions they need followed by a return in other words the bottom line is oh you need a 100 instructions I will put a 100 frame here and every frame will contain only one executable instruction and then followed by a return so instead of actually you are running 100 instructions in sequence you're running instruction 1 return jump to the second place the instruction to return term to the third place instruction 3 soul and so forth it's very similar to the toy of Lego okay every piece is innocent and every piece is good but when you weave them together it actually become an evil thing and it's the same thing here every individual instruction or sure the segment of code they all come from the benign section that when we weave them together they will become evil okay so in this video we introduce how the ROP attack actually is conducted it and in the next video we're going to introduce two mechanisms to two mechanisms to defend against a such attack thank you  
